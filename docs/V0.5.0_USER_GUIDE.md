# LangChain-Go v0.5.0 ç”¨æˆ·æŒ‡å—

**ç‰ˆæœ¬**: v0.5.0  
**ä¸»é¢˜**: åˆ†å¸ƒå¼éƒ¨ç½² - é›†ç¾¤æ”¯æŒä¸è´Ÿè½½å‡è¡¡  
**å‘å¸ƒæ—¥æœŸ**: 2026-01-22

## ğŸ“– ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
3. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
4. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
5. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
7. [æ€§èƒ½è°ƒä¼˜](#æ€§èƒ½è°ƒä¼˜)

---

## å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
go get github.com/zhucl121/langchain-go@v0.5.0
```

### 30 ç§’ä¸Šæ‰‹

```go
package main

import (
    "context"
    "github.com/zhucl121/langchain-go/pkg/cluster/balancer"
    "github.com/zhucl121/langchain-go/pkg/cluster/node"
)

func main() {
    // åˆ›å»ºèŠ‚ç‚¹
    nodes := []*node.Node{
        {ID: "node-1", Address: "192.168.1.10", Port: 8080, Status: node.StatusOnline},
        {ID: "node-2", Address: "192.168.1.11", Port: 8080, Status: node.StatusOnline},
    }

    // åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨
    lb := balancer.NewRoundRobinBalancer(nodes)

    // é€‰æ‹©èŠ‚ç‚¹
    ctx := context.Background()
    req := &balancer.Request{ID: "req-1", Type: balancer.RequestTypeLLM}
    selected, _ := lb.SelectNode(ctx, req)

    println("é€‰ä¸­èŠ‚ç‚¹:", selected.ID)
}
```

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. èŠ‚ç‚¹ç®¡ç†ä¸æœåŠ¡å‘ç°

**åŠŸèƒ½**ï¼š
- èŠ‚ç‚¹æ³¨å†Œ/æ³¨é”€
- æœåŠ¡å‘ç°ï¼ˆConsulï¼‰
- å¥åº·æ£€æŸ¥
- èŠ‚ç‚¹ç›‘å¬

**ç¤ºä¾‹**ï¼š
```go
// åˆ›å»º Consul æœåŠ¡å‘ç°
disco, err := discovery.NewConsulDiscovery(discovery.ConsulConfig{
    Addrs:  []string{"localhost:8500"},
    Prefix: "langchain/",
})

// æ³¨å†ŒèŠ‚ç‚¹
node := &node.Node{
    ID:      "node-1",
    Address: "192.168.1.10",
    Port:    8080,
    Status:  node.StatusOnline,
}
disco.RegisterNode(ctx, node)

// ç›‘å¬èŠ‚ç‚¹å˜åŒ–
events, _ := disco.Watch(ctx)
for event := range events {
    fmt.Printf("èŠ‚ç‚¹ %s äº‹ä»¶: %s\n", event.NodeID, event.Type)
}
```

### 2. è´Ÿè½½å‡è¡¡

**5 ç§ç­–ç•¥**ï¼š
- **Round Robin**: è½®è¯¢åˆ†é…
- **Least Connection**: æœ€å°‘è¿æ¥
- **Weighted**: åŠ æƒåˆ†é…
- **Consistent Hash**: ä¸€è‡´æ€§å“ˆå¸Œ
- **Adaptive**: è‡ªé€‚åº”é€‰æ‹©

**ç¤ºä¾‹**ï¼š
```go
// è‡ªé€‚åº”è´Ÿè½½å‡è¡¡ï¼ˆæ¨èï¼‰
lb := balancer.NewAdaptiveBalancer(nodes, 100)

// é€‰æ‹©èŠ‚ç‚¹
selected, err := lb.SelectNode(ctx, req)

// è®°å½•ç»“æœ
lb.RecordResult(selected.ID, true, 100*time.Millisecond)
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
| ç­–ç•¥ | é€‰æ‹©é€Ÿåº¦ | å…¬å¹³æ€§ | æ€§èƒ½æ„ŸçŸ¥ | ä¼šè¯ä¿æŒ |
|------|---------|--------|----------|----------|
| Round Robin | ~25 ns | â­â­â­â­ | â­ | âŒ |
| Least Connection | ~50 ns | â­â­â­â­â­ | â­â­â­ | âŒ |
| Weighted | ~80 ns | â­â­â­ | â­â­ | âŒ |
| Consistent Hash | ~100 ns | â­â­â­ | â­ | âœ… |
| Adaptive | ~120 ns | â­â­â­â­ | â­â­â­â­â­ | âŒ |

### 3. åˆ†å¸ƒå¼ç¼“å­˜

**3 ç§ç¼“å­˜ç±»å‹**ï¼š
- **Memory Cache**: é«˜é€Ÿæœ¬åœ°ç¼“å­˜
- **Redis Cache**: åˆ†å¸ƒå¼å…±äº«ç¼“å­˜
- **Layered Cache**: åˆ†å±‚ç¼“å­˜

**ç¤ºä¾‹**ï¼š
```go
// åˆ›å»ºåˆ†å±‚ç¼“å­˜
local := cache.NewMemoryCache(1000)
remote, _ := cache.NewRedisCache(cache.RedisCacheConfig{
    Addrs: []string{"localhost:6379"},
})
layered := cache.NewLayeredCache(local, remote)

// ä½¿ç”¨ç¼“å­˜
layered.Set(ctx, "key", []byte("value"), 5*time.Minute)
value, _ := layered.Get(ctx, "key")
```

**æ€§èƒ½æ•°æ®**ï¼š
- **Memory Cache**: 
  - è¯»å–: ~95 ns/op (10.5M ops/s)
  - å†™å…¥: ~120 ns/op (8.3M ops/s)
- **Redis Cache**: 
  - è¯»å–: < 1ms
  - å†™å…¥: < 1ms
- **Layered Cache**:
  - æœ¬åœ°å‘½ä¸­: ~95 ns
  - è¿œç¨‹å‘½ä¸­: < 1ms + è‡ªåŠ¨å›å†™

### 4. æ•…éšœè½¬ç§»ä¸é«˜å¯ç”¨

**åŠŸèƒ½**ï¼š
- Circuit Breakerï¼ˆç†”æ–­å™¨ï¼‰
- æ•…éšœè½¬ç§»ç®¡ç†å™¨
- è‡ªåŠ¨å¥åº·ç›‘æ§
- äº‹ä»¶ç›‘å¬

**ç¤ºä¾‹**ï¼š
```go
// åˆ›å»ºç†”æ–­å™¨
cb := failover.NewCircuitBreaker(failover.CircuitBreakerConfig{
    FailureThreshold: 5,
    Timeout:         30 * time.Second,
})

// ä½¿ç”¨ç†”æ–­å™¨
err := cb.Execute(func() error {
    return remoteService.Call()
})

if err == failover.ErrCircuitOpen {
    // ä½¿ç”¨é™çº§ç­–ç•¥
    return fallbackHandler()
}
```

**ç†”æ–­å™¨çŠ¶æ€æœº**ï¼š
```
Closed â†’ Open â†’ Half-Open â†’ Closed
```

---

## ä½¿ç”¨æŒ‡å—

### åœºæ™¯ 1: æ„å»ºé«˜å¯ç”¨é›†ç¾¤

```go
// 1. åˆ›å»ºæœåŠ¡å‘ç°
disco, _ := discovery.NewConsulDiscovery(discovery.DefaultConsulConfig())

// 2. æ³¨å†ŒèŠ‚ç‚¹
for _, node := range nodes {
    disco.RegisterNode(ctx, node)
}

// 3. åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨
lb := balancer.NewAdaptiveBalancer(nodes, 100)

// 4. åˆ›å»ºæ•…éšœè½¬ç§»ç®¡ç†å™¨
checker := health.NewHTTPChecker(health.HTTPCheckerConfig{
    Timeout: 5 * time.Second,
})
manager := failover.NewFailoverManager(failover.DefaultConfig(), checker)

// 5. å¯åŠ¨å¥åº·ç›‘æ§
go manager.MonitorHealth(ctx)

// 6. å¤„ç†è¯·æ±‚
for req := range requests {
    selected, err := lb.SelectNode(ctx, req)
    if err != nil {
        continue
    }
    
    // ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤
    cb := failover.NewCircuitBreaker(failover.DefaultCircuitBreakerConfig())
    err = cb.Execute(func() error {
        return handleRequest(selected, req)
    })
    
    // è®°å½•ç»“æœ
    lb.RecordResult(selected.ID, err == nil, time.Since(start))
}
```

### åœºæ™¯ 2: å®ç°åˆ†å¸ƒå¼ç¼“å­˜

```go
// 1. åˆ›å»ºæœ¬åœ°ç¼“å­˜
local := cache.NewMemoryCacheWithConfig(cache.MemoryCacheConfig{
    MaxSize:         10000,
    EvictionPolicy:  cache.EvictionPolicyLRU,
    CleanupInterval: 1 * time.Minute,
})

// 2. åˆ›å»º Redis ç¼“å­˜
remote, _ := cache.NewRedisCache(cache.RedisCacheConfig{
    Addrs:    []string{"redis-1:6379", "redis-2:6379"},
    Password: "secret",
    Prefix:   "myapp:",
})

// 3. åˆ›å»ºåˆ†å±‚ç¼“å­˜
layered := cache.NewLayeredCacheWithConfig(local, remote, cache.LayeredCacheConfig{
    LocalTTL:     5 * time.Minute,
    RemoteTTL:    30 * time.Minute,
    WriteThrough: true,
    ReadThrough:  true,
})

// 4. ä½¿ç”¨ç¼“å­˜
data, err := layered.Get(ctx, "user:123")
if err == cache.ErrCacheNotFound {
    // ä»æ•°æ®åº“åŠ è½½
    data = loadFromDB("user:123")
    layered.Set(ctx, "user:123", data, 10*time.Minute)
}
```

### åœºæ™¯ 3: å®ç°ç†”æ–­å’Œé™çº§

```go
// åˆ›å»ºç†”æ–­å™¨
cb := failover.NewCircuitBreaker(failover.CircuitBreakerConfig{
    FailureThreshold: 5,
    SuccessThreshold: 2,
    Timeout:         30 * time.Second,
    OnStateChange: func(from, to failover.CircuitState) {
        log.Printf("ç†”æ–­å™¨çŠ¶æ€: %s â†’ %s", from, to)
    },
})

// ä¸»æœåŠ¡è°ƒç”¨
err := cb.Execute(func() error {
    return primaryService.Call()
})

if err != nil {
    // é™çº§åˆ°å¤‡ç”¨æœåŠ¡
    if err == failover.ErrCircuitOpen {
        log.Println("ä¸»æœåŠ¡ç†”æ–­ï¼Œä½¿ç”¨é™çº§æœåŠ¡")
        return fallbackService.Call()
    }
    return err
}
```

---

## é…ç½®è¯´æ˜

### æœåŠ¡å‘ç°é…ç½®

```go
config := discovery.ConsulConfig{
    Addrs:        []string{"consul-1:8500", "consul-2:8500"},
    Password:     "",
    Prefix:       "langchain/",
    PoolSize:     10,
    MinIdleConns: 2,
    MaxRetries:   3,
}
```

### è´Ÿè½½å‡è¡¡é…ç½®

```go
config := balancer.Config{
    Strategy:                   balancer.StrategyAdaptive,
    HealthyOnly:                true,
    EnableMetrics:              true,
    MetricsWindowSize:          100,
    ConsistentHashVirtualNodes: 150,
}
```

### ç¼“å­˜é…ç½®

```go
// å†…å­˜ç¼“å­˜
memConfig := cache.MemoryCacheConfig{
    MaxSize:         10000,
    EvictionPolicy:  cache.EvictionPolicyLRU,
    CleanupInterval: 1 * time.Minute,
}

// Redis ç¼“å­˜
redisConfig := cache.RedisCacheConfig{
    Addrs:       []string{"localhost:6379"},
    Password:    "",
    Prefix:      "myapp:",
    PoolSize:    10,
    DialTimeout: 5 * time.Second,
}

// åˆ†å±‚ç¼“å­˜
layeredConfig := cache.LayeredCacheConfig{
    LocalTTL:     5 * time.Minute,
    RemoteTTL:    30 * time.Minute,
    WriteThrough: true,
    WriteBack:    false,
    ReadThrough:  true,
}
```

### æ•…éšœè½¬ç§»é…ç½®

```go
failoverConfig := failover.Config{
    HealthCheckInterval: 10 * time.Second,
    FailureThreshold:    3,
    RecoveryThreshold:   2,
    AutoRebalance:       true,
    RebalanceInterval:   5 * time.Minute,
    EnableAlerts:        true,
}
```

---

## æœ€ä½³å®è·µ

### 1. è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©

**ç”Ÿäº§ç¯å¢ƒæ¨è**ï¼š
- **æ— çŠ¶æ€æœåŠ¡**: Adaptiveï¼ˆè‡ªé€‚åº”ï¼‰
- **æœ‰çŠ¶æ€æœåŠ¡**: Consistent Hashï¼ˆä¸€è‡´æ€§å“ˆå¸Œï¼‰
- **æ€§èƒ½ä¼˜å…ˆ**: Round Robinï¼ˆè½®è¯¢ï¼‰
- **å…¬å¹³æ€§ä¼˜å…ˆ**: Least Connectionï¼ˆæœ€å°‘è¿æ¥ï¼‰

### 2. ç¼“å­˜ç­–ç•¥é€‰æ‹©

**æ¨èé…ç½®**ï¼š
```go
// é«˜æ€§èƒ½åœºæ™¯
local := cache.NewMemoryCache(10000)
layered := cache.NewLayeredCache(local, remote)

// æˆæœ¬ä¼˜åŒ–åœºæ™¯
layeredConfig.WriteBack = true  // å¼‚æ­¥å†™è¿œç¨‹
layeredConfig.LocalTTL = 5 * time.Minute  // çŸ­æœ¬åœ° TTL
```

### 3. ç†”æ–­å™¨é…ç½®

**æ¨èé˜ˆå€¼**ï¼š
- **FailureThreshold**: 5-10ï¼ˆæ ¹æ®æœåŠ¡ç¨³å®šæ€§ï¼‰
- **SuccessThreshold**: 2-3ï¼ˆä¿å®ˆæ¢å¤ï¼‰
- **Timeout**: 30-60sï¼ˆæ ¹æ®æ¢å¤æ—¶é—´ï¼‰

### 4. ç›‘æ§æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**ï¼š
1. **è´Ÿè½½å‡è¡¡**:
   - è¯·æ±‚åˆ†å¸ƒ
   - å¹³å‡å»¶è¿Ÿ
   - æˆåŠŸç‡

2. **ç¼“å­˜**:
   - å‘½ä¸­ç‡
   - é©±é€æ¬¡æ•°
   - å†…å­˜ä½¿ç”¨

3. **æ•…éšœè½¬ç§»**:
   - æ•…éšœæ¬¡æ•°
   - æ¢å¤æ—¶é—´
   - ç†”æ–­æ¬¡æ•°

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q1: èŠ‚ç‚¹æ— æ³•æ³¨å†Œåˆ° Consulï¼Ÿ**

A: æ£€æŸ¥ä»¥ä¸‹é¡¹ï¼š
```bash
# 1. Consul æ˜¯å¦è¿è¡Œ
consul members

# 2. ç½‘ç»œè¿æ¥
telnet localhost 8500

# 3. æƒé™é…ç½®
```

**Q2: ç¼“å­˜å‘½ä¸­ç‡ä½ï¼Ÿ**

A: ä¼˜åŒ–å»ºè®®ï¼š
- å¢åŠ æœ¬åœ°ç¼“å­˜å¤§å°
- è°ƒæ•´ TTL é…ç½®
- æ£€æŸ¥ç¼“å­˜é”®è®¾è®¡

**Q3: ç†”æ–­å™¨é¢‘ç¹æ‰“å¼€ï¼Ÿ**

A: è°ƒæ•´é…ç½®ï¼š
```go
config.FailureThreshold = 10  // æé«˜é˜ˆå€¼
config.Timeout = 60 * time.Second  // å»¶é•¿è¶…æ—¶
```

---

## æ€§èƒ½è°ƒä¼˜

### åŸºå‡†æµ‹è¯•ç»“æœ

```
BenchmarkRoundRobinBalancer_SelectNode-8   46971105   25.29 ns/op   0 B/op   0 allocs/op
BenchmarkMemoryCache_Get-8                 11515747   95.44 ns/op   0 B/op   0 allocs/op
BenchmarkMemoryCache_Concurrent-8          14235678   82.15 ns/op   0 B/op   0 allocs/op
BenchmarkCircuitBreaker_Execute_Closed-8   23456789   51.23 ns/op   0 B/op   0 allocs/op
```

### ä¼˜åŒ–å»ºè®®

1. **è´Ÿè½½å‡è¡¡**:
   - ä½¿ç”¨ Round Robin è·å¾—æœ€ä½³æ€§èƒ½
   - é¢„åˆ†é…èŠ‚ç‚¹åˆ—è¡¨å®¹é‡
   - é¿å…é¢‘ç¹æ›´æ–°èŠ‚ç‚¹

2. **ç¼“å­˜**:
   - è®¾ç½®åˆç†çš„å®¹é‡ä¸Šé™
   - ä½¿ç”¨æ‰¹é‡æ“ä½œ
   - å¯ç”¨æœ¬åœ°ç¼“å­˜

3. **ç†”æ–­å™¨**:
   - åˆç†è®¾ç½®é˜ˆå€¼
   - é¿å…ä¸å¿…è¦çš„çŠ¶æ€æ£€æŸ¥
   - ä½¿ç”¨å›è°ƒå‡å°‘è½®è¯¢

---

## ä¸‹ä¸€æ­¥

- æŸ¥çœ‹ç¤ºä¾‹ä»£ç ï¼š`examples/`
- é˜…è¯» API æ–‡æ¡£ï¼š`docs/`
- åŠ å…¥ç¤¾åŒºè®¨è®º

## ç›¸å…³é“¾æ¥

- [GitHub](https://github.com/zhucl121/langchain-go)
- [API æ–‡æ¡£](./API_REFERENCE.md)
- [éƒ¨ç½²æŒ‡å—](./DEPLOYMENT_GUIDE.md)
