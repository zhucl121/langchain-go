# MCP (Model Context Protocol) è§„èŒƒæ–‡æ¡£

**ç‰ˆæœ¬**: v0.6.1  
**åŸºäº**: Anthropic MCP Specification  
**æ—¥æœŸ**: 2026-01-22

---

## ğŸ“‹ ç›®å½•

- [åè®®æ¦‚è¿°](#åè®®æ¦‚è¿°)
- [æ¶ˆæ¯æ ¼å¼](#æ¶ˆæ¯æ ¼å¼)
- [èµ„æºç®¡ç†](#èµ„æºç®¡ç†)
- [å·¥å…·è°ƒç”¨](#å·¥å…·è°ƒç”¨)
- [Prompt ç®¡ç†](#prompt-ç®¡ç†)
- [é‡‡æ ·æœºåˆ¶](#é‡‡æ ·æœºåˆ¶)
- [ä¼ è¾“å±‚](#ä¼ è¾“å±‚)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)

---

## åè®®æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ MCPï¼Ÿ

**Model Context Protocol (MCP)** æ˜¯ Anthropic æå‡ºçš„å¼€æ”¾æ ‡å‡†åè®®ï¼Œç”¨äº AI æ¨¡å‹ä¸å¤–éƒ¨å·¥å…·ã€æ•°æ®æºä¹‹é—´çš„æ ‡å‡†åŒ–é€šä¿¡ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

1. **Server** - æä¾›èµ„æºã€å·¥å…·ã€Prompts çš„æœåŠ¡ç«¯
2. **Client** - ä½¿ç”¨è¿™äº›èƒ½åŠ›çš„å®¢æˆ·ç«¯ï¼ˆå¦‚ Claude Desktopï¼‰
3. **Resources** - å¯è¢« AI è®¿é—®çš„æ•°æ®æº
4. **Tools** - AI å¯ä»¥è°ƒç”¨çš„åŠŸèƒ½
5. **Prompts** - é¢„å®šä¹‰çš„ Prompt æ¨¡æ¿
6. **Sampling** - Server è¯·æ±‚ Client ä½¿ç”¨ LLM ç”Ÿæˆå†…å®¹

### è®¾è®¡åŸåˆ™

- **æ ‡å‡†åŒ–** - ç»Ÿä¸€çš„æ¥å£å®šä¹‰
- **å¯æ‰©å±•** - çµæ´»çš„èƒ½åŠ›å£°æ˜
- **å®‰å…¨** - å†…ç½®æƒé™å’ŒéªŒè¯
- **é«˜æ•ˆ** - åŸºäº JSON-RPC 2.0

---

## æ¶ˆæ¯æ ¼å¼

### JSON-RPC 2.0

MCP ä½¿ç”¨ JSON-RPC 2.0 ä½œä¸ºåº•å±‚é€šä¿¡åè®®ã€‚

#### è¯·æ±‚æ ¼å¼

```json
{
  "jsonrpc": "2.0",
  "id": "req-123",
  "method": "resources/list",
  "params": {
    "cursor": null
  }
}
```

**å­—æ®µè¯´æ˜**:
- `jsonrpc`: å›ºå®šä¸º `"2.0"`
- `id`: è¯·æ±‚ IDï¼ˆstring æˆ– numberï¼‰
- `method`: æ–¹æ³•å
- `params`: å‚æ•°å¯¹è±¡ï¼ˆå¯é€‰ï¼‰

#### å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "req-123",
  "result": {
    "resources": [...]
  }
}
```

**é”™è¯¯å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "req-123",
  "error": {
    "code": -32600,
    "message": "Invalid Request",
    "data": {
      "details": "..."
    }
  }
}
```

### é€šçŸ¥

é€šçŸ¥æ˜¯å•å‘æ¶ˆæ¯ï¼Œä¸éœ€è¦å“åº”ï¼š

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/resources/updated",
  "params": {
    "uri": "file:///docs/guide.txt"
  }
}
```

---

## èµ„æºç®¡ç†

### èµ„æºç±»å‹

MCP èµ„æºä½¿ç”¨ URI æ ‡è¯†ï¼Œæ”¯æŒå¤šç§ç±»å‹ï¼š

- `file://` - æ–‡ä»¶ç³»ç»Ÿ
- `db://` - æ•°æ®åº“
- `vector://` - å‘é‡å­˜å‚¨
- `api://` - API ç«¯ç‚¹
- `github://` - GitHub ä»“åº“
- è‡ªå®šä¹‰ scheme

### èµ„æºå¯¹è±¡

```json
{
  "uri": "file:///documents/guide.txt",
  "name": "User Guide",
  "description": "Complete user guide",
  "mimeType": "text/plain",
  "metadata": {
    "size": 1024,
    "lastModified": "2026-01-22T10:00:00Z",
    "tags": ["documentation", "guide"]
  }
}
```

### èµ„æºæ“ä½œ

#### 1. åˆ—å‡ºèµ„æº

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "1",
  "method": "resources/list",
  "params": {
    "cursor": null
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "1",
  "result": {
    "resources": [
      {
        "uri": "file:///docs/guide.txt",
        "name": "User Guide",
        "mimeType": "text/plain"
      },
      {
        "uri": "db://customers",
        "name": "Customer Database",
        "mimeType": "application/sql"
      }
    ],
    "nextCursor": "page-2"
  }
}
```

#### 2. è¯»å–èµ„æº

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "2",
  "method": "resources/read",
  "params": {
    "uri": "file:///docs/guide.txt"
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "2",
  "result": {
    "contents": [
      {
        "uri": "file:///docs/guide.txt",
        "mimeType": "text/plain",
        "text": "Welcome to the user guide..."
      }
    ]
  }
}
```

**äºŒè¿›åˆ¶å†…å®¹**:

```json
{
  "contents": [
    {
      "uri": "file:///images/logo.png",
      "mimeType": "image/png",
      "blob": "iVBORw0KGgoAAAANSUhEUgAA..."
    }
  ]
}
```

#### 3. è®¢é˜…èµ„æº

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "3",
  "method": "resources/subscribe",
  "params": {
    "uri": "file:///logs/app.log"
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "3",
  "result": {
    "subscribed": true
  }
}
```

**æ›´æ–°é€šçŸ¥**:

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/resources/updated",
  "params": {
    "uri": "file:///logs/app.log"
  }
}
```

#### 4. å–æ¶ˆè®¢é˜…

```json
{
  "jsonrpc": "2.0",
  "id": "4",
  "method": "resources/unsubscribe",
  "params": {
    "uri": "file:///logs/app.log"
  }
}
```

---

## å·¥å…·è°ƒç”¨

### å·¥å…·å®šä¹‰

```json
{
  "name": "calculator",
  "description": "Perform mathematical calculations",
  "inputSchema": {
    "type": "object",
    "properties": {
      "expression": {
        "type": "string",
        "description": "Mathematical expression to evaluate"
      }
    },
    "required": ["expression"]
  }
}
```

### å·¥å…·æ“ä½œ

#### 1. åˆ—å‡ºå·¥å…·

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "5",
  "method": "tools/list",
  "params": {
    "cursor": null
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "5",
  "result": {
    "tools": [
      {
        "name": "calculator",
        "description": "Perform calculations",
        "inputSchema": {...}
      },
      {
        "name": "search",
        "description": "Search the web",
        "inputSchema": {...}
      }
    ]
  }
}
```

#### 2. è°ƒç”¨å·¥å…·

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "6",
  "method": "tools/call",
  "params": {
    "name": "calculator",
    "arguments": {
      "expression": "2 + 3 * 4"
    }
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "6",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "14"
      }
    ],
    "isError": false
  }
}
```

**é”™è¯¯å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "6",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "Error: Division by zero"
      }
    ],
    "isError": true
  }
}
```

### å†…å®¹å—ç±»å‹

å·¥å…·å¯ä»¥è¿”å›å¤šç§ç±»å‹çš„å†…å®¹ï¼š

#### æ–‡æœ¬å†…å®¹

```json
{
  "type": "text",
  "text": "Result: 42"
}
```

#### å›¾åƒå†…å®¹

```json
{
  "type": "image",
  "data": "base64_encoded_image_data",
  "mimeType": "image/png"
}
```

#### èµ„æºå¼•ç”¨

```json
{
  "type": "resource",
  "resource": {
    "uri": "file:///output/result.txt",
    "name": "Calculation Result",
    "mimeType": "text/plain"
  }
}
```

---

## Prompt ç®¡ç†

### Prompt å®šä¹‰

```json
{
  "name": "code_review",
  "description": "Review code for issues",
  "arguments": [
    {
      "name": "code",
      "description": "Code to review",
      "required": true
    },
    {
      "name": "language",
      "description": "Programming language",
      "required": false
    }
  ]
}
```

### Prompt æ“ä½œ

#### 1. åˆ—å‡º Prompts

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "7",
  "method": "prompts/list",
  "params": {
    "cursor": null
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "7",
  "result": {
    "prompts": [
      {
        "name": "code_review",
        "description": "Review code",
        "arguments": [...]
      }
    ]
  }
}
```

#### 2. è·å– Prompt

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "8",
  "method": "prompts/get",
  "params": {
    "name": "code_review",
    "arguments": {
      "code": "func main() {...}",
      "language": "go"
    }
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "8",
  "result": {
    "description": "Code review prompt",
    "messages": [
      {
        "role": "user",
        "content": {
          "type": "text",
          "text": "Please review the following Go code: ..."
        }
      }
    ]
  }
}
```

---

## é‡‡æ ·æœºåˆ¶

é‡‡æ ·å…è®¸ Server è¯·æ±‚ Client ä½¿ç”¨ LLM ç”Ÿæˆå†…å®¹ã€‚

### åˆ›å»ºæ¶ˆæ¯

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "9",
  "method": "sampling/createMessage",
  "params": {
    "messages": [
      {
        "role": "user",
        "content": {
          "type": "text",
          "text": "What is 2+2?"
        }
      }
    ],
    "modelPreferences": {
      "hints": [
        {"name": "claude-3-sonnet"}
      ],
      "costPriority": 0.5,
      "speedPriority": 0.5,
      "intelligencePriority": 0.8
    },
    "systemPrompt": "You are a helpful assistant.",
    "maxTokens": 1000,
    "temperature": 0.7,
    "stopSequences": ["\n\n"],
    "metadata": {
      "requestId": "req-123"
    }
  }
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "9",
  "result": {
    "role": "assistant",
    "content": {
      "type": "text",
      "text": "2+2 equals 4."
    },
    "model": "claude-3-sonnet-20240229",
    "stopReason": "end_turn"
  }
}
```

### æ¨¡å‹åå¥½

```json
{
  "modelPreferences": {
    "hints": [
      {"name": "gpt-4"},
      {"name": "claude-3-opus"}
    ],
    "costPriority": 0.3,        // æˆæœ¬ä¼˜å…ˆçº§ 0-1
    "speedPriority": 0.7,       // é€Ÿåº¦ä¼˜å…ˆçº§ 0-1
    "intelligencePriority": 0.9 // æ™ºèƒ½ä¼˜å…ˆçº§ 0-1
  }
}
```

---

## ä¼ è¾“å±‚

### Stdio ä¼ è¾“

ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºé€šä¿¡ï¼Œé€‚åˆæœ¬åœ°è¿›ç¨‹ã€‚

**Go å®ç°**:

```go
type StdioTransport struct {
    cmd    *exec.Cmd
    stdin  io.WriteCloser
    stdout io.ReadCloser
    stderr io.ReadCloser
}

func (t *StdioTransport) Send(ctx context.Context, msg *Message) error {
    data, _ := json.Marshal(msg)
    _, err := t.stdin.Write(append(data, '\n'))
    return err
}

func (t *StdioTransport) Receive(ctx context.Context) (*Message, error) {
    scanner := bufio.NewScanner(t.stdout)
    if scanner.Scan() {
        var msg Message
        json.Unmarshal(scanner.Bytes(), &msg)
        return &msg, nil
    }
    return nil, scanner.Err()
}
```

### SSE ä¼ è¾“

ä½¿ç”¨ HTTP Server-Sent Eventsï¼Œé€‚åˆ Web åº”ç”¨ã€‚

**ç«¯ç‚¹**:
- `POST /mcp` - å‘é€è¯·æ±‚
- `GET /mcp/events` - æ¥æ”¶äº‹ä»¶æµ

**ç¤ºä¾‹**:

```http
GET /mcp/events HTTP/1.1
Accept: text/event-stream

data: {"jsonrpc":"2.0","id":"1","result":{...}}

data: {"jsonrpc":"2.0","method":"notifications/resources/updated","params":{...}}
```

### WebSocket ä¼ è¾“

ä½¿ç”¨ WebSocket å…¨åŒå·¥é€šä¿¡ã€‚

**è¿æ¥**:

```javascript
const ws = new WebSocket('ws://localhost:8080/mcp');

ws.onopen = () => {
  ws.send(JSON.stringify({
    jsonrpc: '2.0',
    id: '1',
    method: 'initialize',
    params: {...}
  }));
};

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  // å¤„ç†æ¶ˆæ¯
};
```

---

## é”™è¯¯å¤„ç†

### JSON-RPC é”™è¯¯ç 

| é”™è¯¯ç  | å«ä¹‰ | è¯´æ˜ |
|--------|------|------|
| -32700 | Parse error | JSON è§£æé”™è¯¯ |
| -32600 | Invalid Request | æ— æ•ˆè¯·æ±‚ |
| -32601 | Method not found | æ–¹æ³•ä¸å­˜åœ¨ |
| -32602 | Invalid params | æ— æ•ˆå‚æ•° |
| -32603 | Internal error | å†…éƒ¨é”™è¯¯ |
| -32000 to -32099 | Server error | æœåŠ¡å™¨é”™è¯¯ |

### MCP ç‰¹å®šé”™è¯¯

| é”™è¯¯ç  | å«ä¹‰ |
|--------|------|
| -32000 | Resource not found |
| -32001 | Resource access denied |
| -32002 | Tool not found |
| -32003 | Tool execution failed |
| -32004 | Prompt not found |
| -32005 | Sampling failed |

### é”™è¯¯å“åº”æ ¼å¼

```json
{
  "jsonrpc": "2.0",
  "id": "1",
  "error": {
    "code": -32000,
    "message": "Resource not found",
    "data": {
      "uri": "file:///nonexistent.txt",
      "details": "File does not exist",
      "suggestion": "Check the file path"
    }
  }
}
```

---

## åˆå§‹åŒ–æµç¨‹

### 1. å®¢æˆ·ç«¯å‘èµ·åˆå§‹åŒ–

```json
{
  "jsonrpc": "2.0",
  "id": "init-1",
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "sampling": {},
      "roots": {
        "listChanged": true
      }
    },
    "clientInfo": {
      "name": "claude-desktop",
      "version": "1.0.0"
    }
  }
}
```

### 2. æœåŠ¡ç«¯å“åº”

```json
{
  "jsonrpc": "2.0",
  "id": "init-1",
  "result": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "resources": {
        "subscribe": true,
        "listChanged": false
      },
      "tools": {
        "listChanged": false
      },
      "prompts": {
        "listChanged": false
      },
      "sampling": {}
    },
    "serverInfo": {
      "name": "langchain-go-server",
      "version": "0.6.1"
    }
  }
}
```

### 3. å®¢æˆ·ç«¯ç¡®è®¤åˆå§‹åŒ–å®Œæˆ

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/initialized"
}
```

---

## èƒ½åŠ›åå•†

### æœåŠ¡ç«¯èƒ½åŠ›

```json
{
  "capabilities": {
    "resources": {
      "subscribe": true,      // æ”¯æŒèµ„æºè®¢é˜…
      "listChanged": false    // èµ„æºåˆ—è¡¨æ˜¯å¦å¯å˜
    },
    "tools": {
      "listChanged": false    // å·¥å…·åˆ—è¡¨æ˜¯å¦å¯å˜
    },
    "prompts": {
      "listChanged": true     // Prompt åˆ—è¡¨å¯å˜
    },
    "sampling": {},           // æ”¯æŒé‡‡æ ·
    "logging": {}             // æ”¯æŒæ—¥å¿—
  }
}
```

### å®¢æˆ·ç«¯èƒ½åŠ›

```json
{
  "capabilities": {
    "sampling": {},           // å¯ä»¥æ‰§è¡Œé‡‡æ ·
    "roots": {
      "listChanged": true     // æ ¹ç›®å½•å¯å˜
    }
  }
}
```

---

## ç”Ÿå‘½å‘¨æœŸç®¡ç†

### Ping

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "ping-1",
  "method": "ping"
}
```

**å“åº”**:

```json
{
  "jsonrpc": "2.0",
  "id": "ping-1",
  "result": {}
}
```

### æ—¥å¿—çº§åˆ«

**è¯·æ±‚**:

```json
{
  "jsonrpc": "2.0",
  "id": "log-1",
  "method": "logging/setLevel",
  "params": {
    "level": "debug"
  }
}
```

æ—¥å¿—çº§åˆ«: `debug`, `info`, `notice`, `warning`, `error`, `critical`, `alert`, `emergency`

---

## å®‰å…¨è€ƒè™‘

### 1. èµ„æºè®¿é—®æ§åˆ¶

```go
// ä½¿ç”¨ RBAC æ§åˆ¶è®¿é—®
func (s *Server) CheckResourceAccess(ctx context.Context, uri string) error {
    userID := GetUserID(ctx)
    
    req := &rbac.PermissionRequest{
        UserID:     userID,
        Resource:   "mcp_resource",
        Action:     "read",
        ResourceID: uri,
    }
    
    return s.rbac.CheckPermission(ctx, req)
}
```

### 2. å·¥å…·æ‰§è¡Œæ²™ç®±

```go
// é™åˆ¶å·¥å…·æ‰§è¡Œç¯å¢ƒ
type SandboxedTool struct {
    tool    Tool
    timeout time.Duration
    maxMem  int64
}

func (t *SandboxedTool) Execute(ctx context.Context, args map[string]any) (*ToolResult, error) {
    // è®¾ç½®è¶…æ—¶
    ctx, cancel := context.WithTimeout(ctx, t.timeout)
    defer cancel()
    
    // è®¾ç½®å†…å­˜é™åˆ¶
    // æ‰§è¡Œå·¥å…·
    return t.tool.Execute(ctx, args)
}
```

### 3. è¾“å…¥éªŒè¯

```go
// éªŒè¯å·¥å…·è¾“å…¥
func ValidateToolInput(tool *Tool, args map[string]any) error {
    schema := tool.InputSchema
    
    // JSON Schema éªŒè¯
    return jsonschema.Validate(schema, args)
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ“ä½œ

```json
{
  "jsonrpc": "2.0",
  "id": "batch-1",
  "method": "batch",
  "params": {
    "requests": [
      {"method": "resources/list"},
      {"method": "tools/list"},
      {"method": "prompts/list"}
    ]
  }
}
```

### 2. èµ„æºç¼“å­˜

```go
// å®¢æˆ·ç«¯ç¼“å­˜èµ„æºå†…å®¹
type ResourceCache struct {
    cache map[string]*CachedResource
    mu    sync.RWMutex
}

func (c *ResourceCache) Get(uri string) (*ResourceContent, bool) {
    c.mu.RLock()
    defer c.mu.RUnlock()
    
    cached, ok := c.cache[uri]
    if !ok || time.Since(cached.FetchedAt) > 5*time.Minute {
        return nil, false
    }
    
    return cached.Content, true
}
```

### 3. è¿æ¥å¤ç”¨

```go
// å¤ç”¨ WebSocket è¿æ¥
type ConnectionPool struct {
    conns map[string]*websocket.Conn
    mu    sync.Mutex
}
```

---

## å‚è€ƒèµ„æ–™

- [MCP å®˜æ–¹è§„èŒƒ](https://modelcontextprotocol.io/)
- [JSON-RPC 2.0 è§„èŒƒ](https://www.jsonrpc.org/specification)
- [Claude Desktop æ–‡æ¡£](https://claude.ai/docs)

---

**åˆ›å»ºæ—¥æœŸ**: 2026-01-22  
**æœ€åæ›´æ–°**: 2026-01-22  
**ç‰ˆæœ¬**: v0.6.1
