# æ•…éšœè½¬ç§»ä¸é«˜å¯ç”¨ç¤ºä¾‹

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº† LangChain-Go çš„æ•…éšœè½¬ç§»å’Œé«˜å¯ç”¨åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç†”æ–­å™¨å’Œæ•…éšœè½¬ç§»ç®¡ç†å™¨ã€‚

## åŠŸèƒ½æ¼”ç¤º

- âœ… ç†”æ–­å™¨ (Circuit Breaker)
- âœ… ç†”æ–­å™¨æ¢å¤
- âœ… æ•…éšœè½¬ç§»ç®¡ç†å™¨
- âœ… äº‹ä»¶ç›‘å¬

## è¿è¡Œç¤ºä¾‹

```bash
cd examples/failover_demo
go run main.go
```

## ç¤ºä¾‹è¾“å‡º

```
ğŸš€ LangChain-Go æ•…éšœè½¬ç§»ä¸é«˜å¯ç”¨ç¤ºä¾‹
========================================

==================================================
âš¡ ç†”æ–­å™¨ (Circuit Breaker)
ç‰¹ç‚¹: è‡ªåŠ¨ç†”æ–­ï¼Œä¿æŠ¤æœåŠ¡å…å—æ•…éšœå½±å“

  1. æ­£å¸¸è¯·æ±‚...
    âœ… è¯·æ±‚ #1 æˆåŠŸ
    âœ… è¯·æ±‚ #2 æˆåŠŸ
    âœ… è¯·æ±‚ #3 æˆåŠŸ

    å½“å‰çŠ¶æ€: closed

  2. è§¦å‘å¤±è´¥...
    âŒ è¯·æ±‚ #1 å¤±è´¥: service unavailable
    âŒ è¯·æ±‚ #2 å¤±è´¥: service unavailable
    âŒ è¯·æ±‚ #3 å¤±è´¥: service unavailable

    å½“å‰çŠ¶æ€: open (ç†”æ–­å™¨å·²æ‰“å¼€)

  3. å°è¯•æ–°è¯·æ±‚ï¼ˆè¢«æ‹’ç»ï¼‰...
    âš ï¸  è¯·æ±‚è¢«æ‹’ç» - ç†”æ–­å™¨å¤„äºæ‰“å¼€çŠ¶æ€

  4. ç»Ÿè®¡ä¿¡æ¯:
    æ€»è¯·æ±‚: 7 æ¬¡
    æˆåŠŸè¯·æ±‚: 3 æ¬¡
    å¤±è´¥è¯·æ±‚: 3 æ¬¡
    è¢«æ‹’ç»: 1 æ¬¡

==================================================
ğŸ”„ ç†”æ–­å™¨æ¢å¤ (Circuit Breaker Recovery)
ç‰¹ç‚¹: è‡ªåŠ¨æ¢æµ‹æ¢å¤ï¼Œé€æ­¥æ”¾è¡Œæµé‡

  1. è§¦å‘ç†”æ–­...
    âŒ å¤±è´¥ #1
    âŒ å¤±è´¥ #2

    å½“å‰çŠ¶æ€: open

  2. ç­‰å¾…è¶…æ—¶ï¼ˆ1ç§’ï¼‰...

  3. å°è¯•æ¢å¤ï¼ˆåŠå¼€çŠ¶æ€ï¼‰...
    âœ… è¯·æ±‚æˆåŠŸ

    å½“å‰çŠ¶æ€: half_open (åŠå¼€çŠ¶æ€)

  4. ç»§ç»­æˆåŠŸè¯·æ±‚...
    âœ… è¯·æ±‚æˆåŠŸ

    å½“å‰çŠ¶æ€: closed (å·²æ¢å¤)

  5. ç»Ÿè®¡ä¿¡æ¯:
    æ€»è¯·æ±‚: 4 æ¬¡
    æˆåŠŸè¯·æ±‚: 2 æ¬¡
    å¤±è´¥è¯·æ±‚: 2 æ¬¡

==================================================
ğŸ”§ æ•…éšœè½¬ç§»ç®¡ç†å™¨ (Failover Manager)
ç‰¹ç‚¹: è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œè½¬ç§»

  1. åˆå§‹çŠ¶æ€ - æ‰€æœ‰èŠ‚ç‚¹å¥åº·
    âœ… node-1: å¥åº·
    âœ… node-2: å¥åº·
    âœ… node-3: å¥åº·

  2. æ¨¡æ‹Ÿ node-2 æ•…éšœ...
    âŒ node-2 å¥åº·æ£€æŸ¥å¤±è´¥ (1/2)
    âŒ node-2 å¥åº·æ£€æŸ¥å¤±è´¥ (2/2)

  3. æ•…éšœè½¬ç§»å®Œæˆ:
    æ€»æ•…éšœæ¬¡æ•°: 1
    node-2 çŠ¶æ€: failed
    node-2 æ•…éšœæ¬¡æ•°: 1

  4. æ¨¡æ‹Ÿ node-2 æ¢å¤...
    âœ… node-2 å¥åº·æ£€æŸ¥æˆåŠŸ (1/2)
    âœ… node-2 å¥åº·æ£€æŸ¥æˆåŠŸ (2/2)

  5. æ¢å¤å®Œæˆ:
    æ€»æ¢å¤æ¬¡æ•°: 1
    node-2 çŠ¶æ€: healthy
    node-2 æ¢å¤æ¬¡æ•°: 1

==================================================
ğŸ“¡ æ•…éšœè½¬ç§»äº‹ä»¶ç›‘å¬
ç‰¹ç‚¹: å®æ—¶ç›‘å¬æ•…éšœå’Œæ¢å¤äº‹ä»¶

  1. è§¦å‘æ•…éšœ...

  2. è§¦å‘æ¢å¤...

  3. äº‹ä»¶æ—¥å¿—:
    [14:23:45] æ•…éšœäº‹ä»¶: node-1 - node_marked_failed
    [14:23:45] æ•…éšœäº‹ä»¶: node-1 - failover_started
    [14:23:45] æ•…éšœäº‹ä»¶: node-1 - failover_completed
    [14:23:45] æ¢å¤äº‹ä»¶: node-1 - recovery_started
    [14:23:45] æ¢å¤äº‹ä»¶: node-1 - recovery_completed

  4. æœ€ç»ˆç»Ÿè®¡:
    æ€»æ•…éšœ: 1 æ¬¡
    æ€»æ¢å¤: 1 æ¬¡

==================================================
âœ… æ‰€æœ‰æ¼”ç¤ºå®Œæˆï¼
```

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Circuit Breakerï¼ˆç†”æ–­å™¨ï¼‰

**çŠ¶æ€æœº**:
```
Closed (å…³é—­) â†’ Open (æ‰“å¼€) â†’ Half-Open (åŠå¼€) â†’ Closed
```

**å·¥ä½œåŸç†**:
1. **Closed**: æ­£å¸¸å·¥ä½œï¼Œç»Ÿè®¡å¤±è´¥æ¬¡æ•°
2. **Open**: å¤±è´¥è¶…è¿‡é˜ˆå€¼ï¼Œæ‹’ç»æ‰€æœ‰è¯·æ±‚
3. **Half-Open**: è¶…æ—¶åå°è¯•æ¢å¤ï¼Œé™åˆ¶è¯·æ±‚æ•°
4. **Closed**: æ¢å¤æˆåŠŸï¼Œæ¢å¤æ­£å¸¸

**é€‚ç”¨åœºæ™¯**:
- é˜²æ­¢çº§è”æ•…éšœ
- å¿«é€Ÿå¤±è´¥
- æœåŠ¡é™çº§
- ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡

### 2. Failover Managerï¼ˆæ•…éšœè½¬ç§»ç®¡ç†å™¨ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**:
- å¥åº·ç›‘æ§
- æ•…éšœæ£€æµ‹
- è‡ªåŠ¨è½¬ç§»
- èŠ‚ç‚¹æ¢å¤
- è´Ÿè½½é‡å¹³è¡¡

**å·¥ä½œæµç¨‹**:
```
ç›‘æ§ â†’ æ£€æµ‹æ•…éšœ â†’ æ ‡è®°å¤±è´¥ â†’ è½¬ç§»æµé‡ â†’ ç­‰å¾…æ¢å¤ â†’ æ¢å¤èŠ‚ç‚¹
```

**é€‚ç”¨åœºæ™¯**:
- é›†ç¾¤ç®¡ç†
- é«˜å¯ç”¨éƒ¨ç½²
- æ•…éšœè‡ªæ„ˆ
- æœåŠ¡ç¼–æ’

## é…ç½®è¯´æ˜

### Circuit Breaker é…ç½®

```go
config := failover.CircuitBreakerConfig{
    FailureThreshold: 5,        // å¤±è´¥é˜ˆå€¼
    SuccessThreshold: 2,        // æ¢å¤é˜ˆå€¼
    Timeout:         30s,        // è¶…æ—¶æ—¶é—´
    MaxRequests:     1,          // åŠå¼€çŠ¶æ€æœ€å¤§è¯·æ±‚
}
```

**å‚æ•°å»ºè®®**:
- **FailureThreshold**: 3-10ï¼ˆæ ¹æ®æœåŠ¡ç¨³å®šæ€§ï¼‰
- **SuccessThreshold**: 2-5ï¼ˆä¿å®ˆæ¢å¤ï¼‰
- **Timeout**: 10s-60sï¼ˆæ ¹æ®æ¢å¤æ—¶é—´ï¼‰
- **MaxRequests**: 1-3ï¼ˆé€æ­¥æ”¾è¡Œï¼‰

### Failover Manager é…ç½®

```go
config := failover.Config{
    HealthCheckInterval: 10s,    // å¥åº·æ£€æŸ¥é—´éš”
    FailureThreshold:    3,      // æ•…éšœé˜ˆå€¼
    RecoveryThreshold:   2,      // æ¢å¤é˜ˆå€¼
    AutoRebalance:       true,   // è‡ªåŠ¨é‡å¹³è¡¡
    RebalanceInterval:   5m,     // é‡å¹³è¡¡é—´éš”
    EnableAlerts:        true,   // å¯ç”¨å‘Šè­¦
}
```

**å‚æ•°å»ºè®®**:
- **HealthCheckInterval**: 5s-30sï¼ˆå¹³è¡¡å“åº”å’Œè´Ÿè½½ï¼‰
- **FailureThreshold**: 2-5ï¼ˆé¿å…è¯¯åˆ¤ï¼‰
- **RecoveryThreshold**: 2-3ï¼ˆç¡®è®¤æ¢å¤ï¼‰
- **AutoRebalance**: ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨

## æœ€ä½³å®è·µ

### 1. ç†”æ–­å™¨ä½¿ç”¨

```go
// åŒ…è£…è¿œç¨‹è°ƒç”¨
cb := failover.NewCircuitBreaker(config)

result, err := cb.Execute(func() error {
    return remoteService.Call()
})

if err == failover.ErrCircuitOpen {
    // ä½¿ç”¨é™çº§ç­–ç•¥
    return fallbackHandler()
}
```

### 2. æ•…éšœè½¬ç§»

```go
// æ·»åŠ å¥åº·æ£€æŸ¥
checker := failover.HealthCheckerFunc(func(ctx context.Context, nodeID string) error {
    return httpHealthCheck(nodeID)
})

// åˆ›å»ºç®¡ç†å™¨
manager := failover.NewFailoverManager(config, checker)

// å¯åŠ¨ç›‘æ§
go manager.MonitorHealth(ctx)

// æ·»åŠ äº‹ä»¶ç›‘å¬
manager.AddListener(&MyEventListener{})
```

### 3. å‘Šè­¦é€šçŸ¥

```go
config.AlertCallback = func(alert failover.Alert) {
    switch alert.Severity {
    case failover.SeverityCritical:
        sendPagerDuty(alert)
    case failover.SeverityWarning:
        sendSlack(alert)
    default:
        log.Info(alert)
    }
}
```

## æ€§èƒ½ç‰¹ç‚¹

### Circuit Breaker
- **å¿«é€Ÿå¤±è´¥**: < 1Î¼s
- **çŠ¶æ€æ£€æŸ¥**: æ— é”è¯»å–
- **å†…å­˜å ç”¨**: < 1KB

### Failover Manager
- **å¥åº·æ£€æŸ¥**: å¯é…ç½®é—´éš”
- **æ•…éšœæ£€æµ‹**: 2-3 ä¸ªå‘¨æœŸ
- **æ¢å¤æ—¶é—´**: 2-5 ç§’

## ç›‘æ§æŒ‡æ ‡

æ¨èç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **ç†”æ–­å™¨**:
   - æ‰“å¼€æ¬¡æ•°
   - æ‹’ç»è¯·æ±‚æ•°
   - å¹³å‡æ¢å¤æ—¶é—´

2. **æ•…éšœè½¬ç§»**:
   - æ•…éšœèŠ‚ç‚¹æ•°
   - æ•…éšœæŒç»­æ—¶é—´
   - æ¢å¤æˆåŠŸç‡

## ä¸‹ä¸€æ­¥

æŸ¥çœ‹æ›´å¤šç¤ºä¾‹ï¼š
- è´Ÿè½½å‡è¡¡ç¤ºä¾‹ï¼š`examples/balancer_demo/`
- åˆ†å¸ƒå¼ç¼“å­˜ç¤ºä¾‹ï¼š`examples/cache_demo/`
- é›†ç¾¤ç®¡ç†ç¤ºä¾‹ï¼š`examples/cluster_demo/`

## ç›¸å…³æ–‡æ¡£

- [V0.5.0 å®æ–½è®¡åˆ’](../../docs/V0.5.0_IMPLEMENTATION_PLAN.md)
- [V0.5.0 è¿›åº¦è·Ÿè¸ª](../../docs/V0.5.0_PROGRESS.md)
