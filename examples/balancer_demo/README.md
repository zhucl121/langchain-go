# 负载均衡示例

这个示例展示了 LangChain-Go 的负载均衡功能，包括 5 种不同的负载均衡策略。

## 功能演示

- ✅ 轮询负载均衡 (Round Robin)
- ✅ 最少连接负载均衡 (Least Connection)
- ✅ 加权负载均衡 (Weighted)
- ✅ 一致性哈希负载均衡 (Consistent Hash)
- ✅ 自适应负载均衡 (Adaptive)

## 运行示例

```bash
cd examples/balancer_demo
go run main.go
```

## 示例输出

```
🚀 LangChain-Go 负载均衡示例
========================================

📋 集群节点列表 (3 个):
  1. worker-1 - 192.168.1.10:8080 (负载: 20.0%)
  2. worker-2 - 192.168.1.11:8080 (负载: 50.0%)
  3. worker-3 - 192.168.1.12:8080 (负载: 15.0%)

==================================================
🔄 轮询负载均衡 (Round Robin)
特点: 按顺序依次选择节点，确保请求均匀分布

  请求 # 1 → worker-1
  请求 # 2 → worker-2
  请求 # 3 → worker-3
  请求 # 4 → worker-1
  ...

  分布统计:
    worker-1:   4 次 (33.3%)
    worker-2:   4 次 (33.3%)
    worker-3:   4 次 (33.3%)

==================================================
📊 最少连接负载均衡 (Least Connection)
特点: 选择当前连接数最少的节点，适合长连接场景

  模拟 10 个并发长连接...
  连接 # 1 → worker-1 (当前连接: 1)
  连接 # 2 → worker-2 (当前连接: 1)
  连接 # 3 → worker-3 (当前连接: 1)
  连接 # 4 → worker-1 (当前连接: 1)
  ...

==================================================
⚖️  加权负载均衡 (Weighted)
特点: 根据节点权重分配请求，权重越高分配越多

  权重配置:
    worker-1: 权重 1
    worker-2: 权重 2
    worker-3: 权重 3

  分布统计:
    worker-1:  10 次 (16.7%)
    worker-2:  20 次 (33.3%)
    worker-3:  30 次 (50.0%)

==================================================
🔗 一致性哈希负载均衡 (Consistent Hash)
特点: 相同的请求总是路由到相同的节点，适合缓存场景

  用户路由测试:
    用户    alice → worker-2
      ✅ 一致性验证通过
    用户      bob → worker-1
      ✅ 一致性验证通过
    用户  charlie → worker-3
      ✅ 一致性验证通过
    ...

==================================================
🧠 自适应负载均衡 (Adaptive)
特点: 根据节点实时性能动态调整，优先选择表现好的节点

  模拟节点性能:
    node-1: 快速响应 (50ms), 100% 成功率
    node-2: 中等响应 (150ms), 50% 成功率
    node-3: 慢响应 (300ms), 100% 成功率

  节点得分 (0-1, 越高越好):
    worker-1: 0.883
    worker-2: 0.705
    worker-3: 0.820

  分布统计:
    worker-1:  15 次 (75.0%)
    worker-2:   2 次 (10.0%)
    worker-3:   3 次 (15.0%)

  最终节点得分:
    worker-1: 0.895 (请求: 15, 成功: 15)
    worker-2: 0.698 (请求: 2, 成功: 1)
    worker-3: 0.815 (请求: 3, 成功: 3)

==================================================
✅ 所有演示完成！
```

## 负载均衡策略说明

### 1. 轮询 (Round Robin)

**特点**:
- 按顺序依次选择节点
- 简单高效，无状态
- 适合节点性能相近的场景

**适用场景**:
- 无状态服务
- 节点配置相同
- 快速响应的请求

### 2. 最少连接 (Least Connection)

**特点**:
- 选择当前连接数最少的节点
- 考虑节点实时负载
- 适合长连接场景

**适用场景**:
- WebSocket 长连接
- 处理时间差异大的请求
- 实时负载不均衡

### 3. 加权 (Weighted)

**特点**:
- 根据节点权重分配请求
- 支持手动或自动计算权重
- 权重越高，分配越多

**适用场景**:
- 节点配置不同
- 需要按比例分配流量
- A/B 测试

### 4. 一致性哈希 (Consistent Hash)

**特点**:
- 相同的请求总是路由到相同节点
- 节点变化时最小化重新分配
- 支持虚拟节点

**适用场景**:
- 需要会话保持
- 分布式缓存
- 有状态服务

### 5. 自适应 (Adaptive)

**特点**:
- 根据节点实时性能动态调整
- 综合考虑多个指标
- 自动优化请求分配

**适用场景**:
- 节点性能波动大
- 需要最优性能
- 生产环境推荐使用

## 性能对比

| 策略 | 简单性 | 公平性 | 性能感知 | 会话保持 |
|------|--------|--------|----------|----------|
| Round Robin | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ | ❌ |
| Least Connection | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ❌ |
| Weighted | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ❌ |
| Consistent Hash | ⭐⭐⭐ | ⭐⭐⭐ | ⭐ | ✅ |
| Adaptive | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ❌ |

## 使用建议

### 开发/测试环境
- 推荐使用 **Round Robin**，简单可靠

### 生产环境
- 无状态服务：**Adaptive** 或 **Least Connection**
- 有状态服务：**Consistent Hash**
- 节点配置不同：**Weighted** + **Adaptive**

## 下一步

查看更多示例：
- 集群管理示例：`examples/cluster_demo/`
- 故障转移示例：`examples/failover_demo/`（开发中）

## 相关文档

- [V0.5.0 实施计划](../../docs/V0.5.0_IMPLEMENTATION_PLAN.md)
- [V0.5.0 进度跟踪](../../docs/V0.5.0_PROGRESS.md)
