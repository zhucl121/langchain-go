# Learning Retrieval - 完整工作流示例

这个示例展示了学习型检索系统的**完整工作流**，从反馈收集到参数优化，再到 A/B 测试验证。

## 完整工作流

```
┌─────────────────┐
│  1. 反馈收集     │  收集用户反馈（显式+隐式）
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  2. 质量评估     │  计算多维度评估指标
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  3. 参数优化     │  贝叶斯优化找最佳参数
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  4. A/B 测试     │  科学验证优化效果
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  5. 推广应用     │  应用到生产环境
└─────────────────┘
```

## 运行示例

```bash
cd examples/learning_complete_demo
go run main.go
```

## 输出示例

```
╔═══════════════════════════════════════════════════════╗
║  LangChain-Go Learning Retrieval - 完整工作流示例      ║
╚═══════════════════════════════════════════════════════╝

📦 步骤 1: 初始化学习型检索系统
─────────────────────────────────────────
✓ 反馈收集器已创建
✓ 质量评估器已创建
✓ 参数优化器已创建
✓ A/B 测试管理器已创建

📊 步骤 2: 收集用户反馈数据
─────────────────────────────────────────
收集策略 'hybrid-search' 的用户反馈...
✓ 已收集 30 个查询的反馈
  • 平均评分: 4.0/5.0
  • 平均点击率: 33.3%

🎯 步骤 3: 评估检索质量
─────────────────────────────────────────
策略性能评估:
  • 综合得分: 0.418
  • NDCG: 0.650
  • MRR: 0.650
  • F1 Score: 0.318

⚠️  性能低于预期，建议进行参数优化

⚙️  步骤 4: 自动参数优化
─────────────────────────────────────────
运行贝叶斯优化（15 次迭代）...
✓ 参数优化完成
  • 最佳参数: top_k=18, temperature=0.72, rerank=mmr
  • 优化前得分: 0.418
  • 优化后得分: 0.487
  • 性能提升: 16.51%

🧪 步骤 5: A/B 测试验证优化效果
─────────────────────────────────────────
✓ A/B 测试实验已创建并启动
收集实验数据...
✓ 实验数据收集完成 (每组 50 个样本)

实验结果:
  优化前（当前参数）:
    • 平均得分: 0.675
    • 置信区间: [0.663, 0.686]
  优化后（最佳参数）:
    • 平均得分: 0.761
    • 置信区间: [0.750, 0.773]

🏆 获胜者: 优化后（最佳参数）
📈 提升: 12.74%
✅ 统计显著性: p = 0.010 (p < 0.05)

💡 优化效果已通过 A/B 测试验证，可以推广到生产环境

📋 步骤 6: 学习型检索完整工作流总结
─────────────────────────────────────────

1️⃣  反馈收集:
   ✓ 收集了 30 个查询的反馈数据
   ✓ 包含显式反馈（评分）和隐式反馈（点击、阅读）

2️⃣  质量评估:
   ✓ 计算了多维度评估指标
   ✓ 综合得分: 0.418

3️⃣  参数优化:
   ✓ 通过 15 次迭代找到最佳参数
   ✓ 性能提升: 16.51%

4️⃣  A/B 测试验证:
   ✓ 实验组相比对照组提升明显
   ✓ 统计显著性: p = 0.010

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 学习型检索系统工作流完成！

📈 整体效果:
   • 从用户反馈中学习
   • 自动发现性能问题
   • 智能优化参数配置
   • 科学验证优化效果
   • 持续提升检索质量
```

## 核心价值

### 1. 闭环学习

系统能够：
- 收集用户真实反馈
- 评估当前性能
- 自动优化参数
- 验证优化效果
- 持续改进

### 2. 数据驱动

决策基于：
- 真实用户行为
- 统计学原理
- 科学验证
- 可量化指标

### 3. 自动化

减少人工干预：
- 自动收集反馈
- 自动评估质量
- 自动优化参数
- 自动分流用户

## 生产环境部署

### 完整架构

```
┌─────────────┐
│   用户查询   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│  检索系统（使用优化后的参数）    │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────┐      ┌──────────────┐
│  反馈收集器      │─────▶│ PostgreSQL   │
└──────┬──────────┘      └──────────────┘
       │
       ▼
┌─────────────────┐
│  质量评估器      │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│  参数优化器      │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│  A/B 测试管理    │
└─────────────────┘
```

### 部署步骤

1. **部署 PostgreSQL**
   ```bash
   docker run -d \
     -e POSTGRES_PASSWORD=password \
     -e POSTGRES_DB=langchain_learning \
     -p 5432:5432 \
     postgres:15
   ```

2. **初始化存储**
   ```go
   db, _ := sql.Open("postgres", connStr)
   storage := feedback.NewPostgreSQLStorage(db)
   storage.(*feedback.PostgreSQLStorage).InitSchema(ctx)
   ```

3. **启动系统**
   ```go
   collector := feedback.NewCollector(storage)
   evaluator := evaluation.NewEvaluator(collector)
   optimizer := optimization.NewOptimizer(evaluator, collector, config)
   abtestManager := abtest.NewManager(abtestStorage)
   ```

4. **开启自动调优**
   ```go
   go optimizer.AutoTune(ctx, strategyID, paramSpace, 
       optimization.AutoTuneConfig{
           CheckInterval:  1 * time.Hour,
           ScoreThreshold: 0.7,
       })
   ```

### 监控指标

建议监控：
- 用户反馈率
- 平均评分趋势
- 点击率 (CTR)
- NDCG/MRR 趋势
- 参数优化频率
- A/B 测试结果

### 告警规则

建议设置：
- 平均评分 < 3.5
- CTR < 20%
- NDCG < 0.5
- 负面反馈率 > 30%

## 实际案例

### 案例 1: 电商搜索优化

**场景**: 优化商品搜索排序

**数据**:
- 收集 10,000 次搜索的点击和购买数据
- 评估当前排序算法（NDCG = 0.65）

**优化**:
- 优化参数：top_k, 相关性权重, 价格权重
- 提升 NDCG 到 0.78 (+20%)

**验证**:
- A/B 测试 2 周
- 实验组转化率提升 15%
- 推广到全量

### 案例 2: 文档检索系统

**场景**: 企业知识库搜索

**数据**:
- 收集用户满意度评分
- 平均评分 3.8/5.0

**优化**:
- 调整向量权重和 BM25 权重
- 优化 rerank 策略
- 评分提升到 4.3/5.0

**效果**:
- 用户查询次数减少 25%（找到答案更快）
- 客服咨询量下降 30%

## 最佳实践总结

### DO ✅

- ✅ 收集完整的用户反馈数据
- ✅ 使用多维度评估指标
- ✅ 定期运行参数优化
- ✅ A/B 测试验证每次改动
- ✅ 持久化数据到数据库
- ✅ 监控系统运行状态

### DON'T ❌

- ❌ 不要忽视用户反馈
- ❌ 不要凭感觉调参数
- ❌ 不要跳过 A/B 测试
- ❌ 不要过早下结论
- ❌ 不要只看单一指标
- ❌ 不要停止学习和优化

## 相关资源

- **Phase 1**: `learning_feedback_demo` - 反馈收集
- **Phase 2**: `learning_evaluation_demo` - 质量评估
- **Phase 3**: `learning_optimization_demo` - 参数优化
- **Phase 4**: `learning_abtest_demo` - A/B 测试
- **生产部署**: `learning_postgres_demo` - PostgreSQL 存储

## 技术支持

- GitHub Issues: https://github.com/zhucl121/langchain-go/issues
- 文档: docs/V0.4.2_USER_GUIDE.md
- API 参考: docs/api/learning/README.md
