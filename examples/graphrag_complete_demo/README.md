# GraphRAG å®Œæ•´åŠŸèƒ½æ¼”ç¤º

è¿™æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„ GraphRAG æ¼”ç¤ºç¨‹åºï¼Œå±•ç¤ºäº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œç‰¹æ€§ã€‚

## åŠŸèƒ½æ¼”ç¤º

### 1. å¤šå›¾æ•°æ®åº“æ”¯æŒ
- **Mock æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰ï¼šä¸éœ€è¦å¤–éƒ¨ä¾èµ–ï¼Œå¿«é€Ÿæµ‹è¯•
- **Neo4j æ¨¡å¼**ï¼šä½¿ç”¨ Neo4j å›¾æ•°æ®åº“
- **NebulaGraph æ¨¡å¼**ï¼šä½¿ç”¨ NebulaGraph åˆ†å¸ƒå¼å›¾æ•°æ®åº“

### 2. çŸ¥è¯†å›¾è°±æ„å»º
- å®ä½“æå–
- å…³ç³»æå–
- æ‰¹é‡æ„å»º
- å›¾åˆå¹¶

### 3. GraphRAG æ£€ç´¢
- **æ··åˆæ£€ç´¢**ï¼šå‘é‡ + å›¾
- **çº¯å‘é‡æ£€ç´¢**ï¼šä»…å‘é‡ç›¸ä¼¼åº¦
- **çº¯å›¾æ£€ç´¢**ï¼šä»…å›¾éå†

### 4. èåˆç­–ç•¥
- **Weighted**ï¼šåŠ æƒèåˆ
- **RRF**ï¼šReciprocal Rank Fusion
- **Max**ï¼šæœ€å¤§å€¼èåˆ
- **Min**ï¼šæœ€å°å€¼èåˆ

### 5. é‡æ’åºç­–ç•¥
- **Score**ï¼šæŒ‰åˆ†æ•°é‡æ’
- **Diversity**ï¼šå¤šæ ·æ€§é‡æ’
- **MMR**ï¼šæœ€å¤§è¾¹é™…ç›¸å…³æ€§

## è¿è¡Œæ–¹å¼

### Mock æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

```bash
# ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦ä»»ä½•å¤–éƒ¨ä¾èµ–
go run examples/graphrag_complete_demo/main.go
```

### Neo4j æ¨¡å¼

```bash
# 1. å¯åŠ¨ Neo4j
docker compose -f docker-compose.graphdb.yml up -d neo4j

# 2. è¿è¡Œæ¼”ç¤ºï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
GRAPH_MODE=neo4j NEO4J_URI=bolt://localhost:7687 \
  go run examples/graphrag_complete_demo/main.go
```

### NebulaGraph æ¨¡å¼

```bash
# 1. å¯åŠ¨ NebulaGraph
docker compose -f docker-compose.graphdb.yml up -d nebula-metad nebula-storaged nebula-graphd

# 2. åˆ›å»ºå›¾ç©ºé—´
docker run --rm -ti --network host vesoft/nebula-console:v3 \
  -addr 127.0.0.1 -port 9669 -u root -p nebula

# åœ¨ console ä¸­æ‰§è¡Œï¼š
CREATE SPACE IF NOT EXISTS langchain_demo(partition_num=10, replica_factor=1, vid_type=FIXED_STRING(256));
USE langchain_demo;
CREATE TAG IF NOT EXISTS Concept(name string, type string);
CREATE EDGE IF NOT EXISTS RELATED_TO(type string);

# 3. è¿è¡Œæ¼”ç¤º
GRAPH_MODE=nebula NEBULA_ADDRESSES=127.0.0.1:9669 \
  go run examples/graphrag_complete_demo/main.go
```

## è¾“å‡ºç¤ºä¾‹

```
========================================
  GraphRAG å®Œæ•´åŠŸèƒ½æ¼”ç¤º
========================================

è¿è¡Œæ¨¡å¼: mock

ğŸ“Š Step 1: æ„å»ºçŸ¥è¯†å›¾è°±...
  âœ“ æ„å»ºäº† 5 ä¸ªå­å›¾
  âœ“ åˆå¹¶å: 8 å®ä½“, 12 å…³ç³»
  âœ“ çŸ¥è¯†å›¾è°±å·²å­˜å‚¨

ğŸ“Š Step 2: å‘é‡åŒ–æ–‡æ¡£...
  âœ“ å‘é‡åŒ–äº† 5 ä¸ªæ–‡æ¡£

ğŸ“Š Step 3: åˆ›å»º GraphRAG æ£€ç´¢å™¨...
  âœ“ GraphRAG æ£€ç´¢å™¨å·²åˆ›å»º

========================================
  æ£€ç´¢æ¨¡å¼å¯¹æ¯”
========================================

ğŸ” æŸ¥è¯¢: äººå·¥æ™ºèƒ½çš„å‘å±•å†å²
------------------------------------------------------------

  ğŸ“Œ æ··åˆæ£€ç´¢ (è€—æ—¶: 12ms)
     ç»“æœæ•°: 5
     [1] Score: 0.875 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.823 | æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿è®¡ç®—æœºç³»...
     [3] Score: 0.756 | æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä½¿ç”¨å¤šå±‚ç¥ç»...

  ğŸ“Œ çº¯å‘é‡æ£€ç´¢ (è€—æ—¶: 5ms)
     ç»“æœæ•°: 5
     [1] Score: 0.892 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.834 | æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿è®¡ç®—æœºç³»...
     [3] Score: 0.778 | è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦åº”...

  ğŸ“Œ çº¯å›¾æ£€ç´¢ (è€—æ—¶: 8ms)
     ç»“æœæ•°: 4
     [1] Score: 0.800 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.750 | æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿è®¡ç®—æœºç³»...
     [3] Score: 0.700 | æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä½¿ç”¨å¤šå±‚ç¥ç»...

========================================
  èåˆç­–ç•¥å¯¹æ¯”
========================================

  ğŸ“Œ åŠ æƒèåˆ (è€—æ—¶: 11ms)
     Top 3 ç»“æœ:
     [1] Score: 0.875 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.823 | æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿è®¡ç®—æœºç³»...
     [3] Score: 0.756 | æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä½¿ç”¨å¤šå±‚ç¥ç»...

  ğŸ“Œ RRF èåˆ (è€—æ—¶: 10ms)
     Top 3 ç»“æœ:
     [1] Score: 0.912 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.856 | æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿è®¡ç®—æœºç³»...
     [3] Score: 0.789 | æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä½¿ç”¨å¤šå±‚ç¥ç»...

========================================
  é‡æ’åºç­–ç•¥å¯¹æ¯”
========================================

  ğŸ“Œ åˆ†æ•°é‡æ’ (è€—æ—¶: 11ms)
     Top 3 ç»“æœ:
     [1] Score: 0.912 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.856 | æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿è®¡ç®—æœºç³»...
     [3] Score: 0.789 | æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä½¿ç”¨å¤šå±‚ç¥ç»...

  ğŸ“Œ å¤šæ ·æ€§é‡æ’ (è€—æ—¶: 13ms)
     Top 3 ç»“æœ:
     [1] Score: 0.912 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.734 | è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦åº”...
     [3] Score: 0.678 | è®¡ç®—æœºè§†è§‰æ˜¯äººå·¥æ™ºèƒ½çš„å¦ä¸€ä¸ªå…³é”®é¢†åŸŸï¼Œä½¿æœº...

  ğŸ“Œ MMR é‡æ’ (è€—æ—¶: 14ms)
     Top 3 ç»“æœ:
     [1] Score: 0.912 | äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äº...
     [2] Score: 0.745 | è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦åº”...
     [3] Score: 0.689 | è®¡ç®—æœºè§†è§‰æ˜¯äººå·¥æ™ºèƒ½çš„å¦ä¸€ä¸ªå…³é”®é¢†åŸŸï¼Œä½¿æœº...

========================================
  ç»Ÿè®¡ä¿¡æ¯
========================================

å‘é‡æ£€ç´¢ç»“æœæ•°: 5
å›¾æ£€ç´¢ç»“æœæ•°: 4
èåˆåç»“æœæ•°: 5
æœ€ç»ˆç»“æœæ•°: 5
å¤„ç†çš„å®ä½“æ•°: 3
éå†çš„èŠ‚ç‚¹æ•°: 12
å¹³å‡èåˆåˆ†æ•°: 0.823

âœ… æ¼”ç¤ºå®Œæˆï¼
```

## æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | å»¶è¿Ÿ | ç»“æœæ•° | ç‰¹ç‚¹ |
|------|------|--------|------|
| Mock | ~10ms | 5 | æœ€å¿«ï¼Œæµ‹è¯•ç”¨ |
| Neo4j | ~50ms | 5 | æˆç†Ÿç¨³å®š |
| NebulaGraph | ~80ms | 5 | åˆ†å¸ƒå¼ï¼Œå¤§è§„æ¨¡ |

## æ‰©å±•ç¤ºä¾‹

### 1. è‡ªå®šä¹‰å®ä½“æå–å™¨

```go
type CustomEntityExtractor struct {
    chatModel chat.ChatModel
}

func (e *CustomEntityExtractor) Extract(ctx context.Context, text string) ([]builder.Entity, error) {
    // ä½¿ç”¨ LLM æå–å®ä½“
    messages := []types.Message{
        types.NewUserMessage(fmt.Sprintf("Extract entities from: %s", text)),
    }
    
    response, err := e.chatModel.Call(ctx, messages)
    if err != nil {
        return nil, err
    }
    
    // è§£æå“åº”...
    return entities, nil
}
```

### 2. è‡ªå®šä¹‰èåˆç­–ç•¥

```go
// è‡ªå®šä¹‰åŠ æƒå‡½æ•°
customWeights := func(vectorScore, graphScore float64) float64 {
    // åŠ¨æ€è°ƒæ•´æƒé‡
    if vectorScore > 0.8 {
        return vectorScore * 0.7 + graphScore * 0.3
    }
    return vectorScore * 0.5 + graphScore * 0.5
}

// åœ¨æ£€ç´¢ä¸­ä½¿ç”¨
results, _ := retriever.Search(ctx, query, graphrag.SearchOptions{
    Mode:         graphrag.SearchModeHybrid,
    VectorWeight: 0.6,
    GraphWeight:  0.4,
    // è‡ªå®šä¹‰é€»è¾‘éœ€è¦åœ¨ retriever å†…éƒ¨å®ç°
})
```

### 3. æ€§èƒ½ä¼˜åŒ–

```go
// æ‰¹é‡æŸ¥è¯¢
queries := []string{"query1", "query2", "query3"}
results := make([][]*types.Document, len(queries))

var wg sync.WaitGroup
for i, query := range queries {
    wg.Add(1)
    go func(idx int, q string) {
        defer wg.Done()
        r, _ := retriever.Search(ctx, q, options)
        results[idx] = r
    }(i, query)
}
wg.Wait()
```

## æ•…éšœæ’é™¤

### Neo4j è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ Neo4j çŠ¶æ€
docker logs langchain-neo4j

# æµ‹è¯•è¿æ¥
curl http://localhost:7474
```

### NebulaGraph è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker ps | grep nebula

# æŸ¥çœ‹ graphd æ—¥å¿—
docker logs langchain-nebula-graphd

# æµ‹è¯•è¿æ¥
curl http://localhost:19669/status
```

### æ€§èƒ½é—®é¢˜

1. **æ£€æŸ¥å¹¶å‘æ•°**ï¼šå‡å°‘å¹¶å‘æŸ¥è¯¢æ•°é‡
2. **è°ƒæ•´æ·±åº¦**ï¼šé™ä½ GraphDepth
3. **é™åˆ¶ç»“æœæ•°**ï¼šå‡å° TopK
4. **ä½¿ç”¨ç¼“å­˜**ï¼šå®ç°ç»“æœç¼“å­˜

## ä¸‹ä¸€æ­¥

- å°è¯•ä¸åŒçš„å›¾æ•°æ®åº“
- è°ƒæ•´èåˆå’Œé‡æ’åºç­–ç•¥
- æ·»åŠ è‡ªå®šä¹‰å®ä½“æå–å™¨
- é›†æˆåˆ°å®é™…åº”ç”¨

## å‚è€ƒèµ„æ–™

- [GraphRAG ç”¨æˆ·æŒ‡å—](../../docs/V0.4.1_USER_GUIDE.md)
- [Neo4j é›†æˆ](../../retrieval/graphdb/neo4j/README.md)
- [NebulaGraph é›†æˆ](../../retrieval/graphdb/nebula/README.md)
